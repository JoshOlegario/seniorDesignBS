// Pin definitions
const int pin22 = 22; //Sensor 1
const int pin24 = 24; //Sensor 2
const int pin26 = 26; //Sensor 3
const int pin4 = 4;   //Motor Output

// Run-off timing
const unsigned long RUN_OFF_TIME = 5000; // 5 seconds run-off (adjust as needed)
unsigned long runOffStartTime = 0;
bool inRunOff = false;

// Sensor state tracking for logging
int lastA = -1;
int lastB = -1;
int lastC = -1;

void setup() {
  // Set up input pins
  pinMode(pin22, INPUT); 
  pinMode(pin24, INPUT);
  pinMode(pin26, INPUT);
  
  // Set up output pin
  pinMode(pin4, OUTPUT);
  
  // Initialize outputs
  digitalWrite(pin4, HIGH);
  
  Serial.begin(115200);
  Serial.println("=== System Started ===");
  Serial.println("Time(ms), Sensor1, Sensor2, Sensor3, Motor, Event");
}

void loop() {
  // Read sensor states
  int a = digitalRead(pin22);
  int b = digitalRead(pin24);
  int c = digitalRead(pin26);
  
  // Log sensor changes
  if (a != lastA || b != lastB || c != lastC) {
    logSensorChange(a, b, c, "Sensor change");
    lastA = a;
    lastB = b;
    lastC = c;
  }
  
  // Handle run-off mode
  if (inRunOff) {
    if (millis() - runOffStartTime >= RUN_OFF_TIME) {
      // Run-off complete
      digitalWrite(pin4, LOW);
      inRunOff = false;
      logMotorState("Run-off complete - Motor OFF");
    } else {
      // Still in run-off, keep motor running
      digitalWrite(pin4, HIGH);
    }
    delay(100);
    return; // Skip normal logic during run-off
  }
  
  // Normal operation logic
  if (a == LOW && b == LOW) {
    // Start run-off period
    if (digitalRead(pin4) == HIGH) { // Only start if motor was running
      inRunOff = true;
      runOffStartTime = millis();
      logMotorState("Both sensors LOW - Starting run-off");
    }
  }
  else if (c == HIGH) {
    // Emergency stop - start run-off
    if (digitalRead(pin4) == HIGH) {
      inRunOff = true;
      runOffStartTime = millis();
      logMotorState("Sensor 3 HIGH - Starting run-off");
    }
  }
  else {
    // Normal operation
    digitalWrite(pin4, HIGH);
  }
  
  delay(100);
}

void logSensorChange(int a, int b, int c, String event) {
  Serial.print(millis());
  Serial.print(", ");
  Serial.print(a == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(b == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(c == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(digitalRead(pin4) == HIGH ? "ON" : "OFF");
  Serial.print(", ");
  Serial.println(event);
}

void logMotorState(String message) {
  Serial.print(millis());
  Serial.print(", ");
  Serial.print(lastA == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(lastB == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(lastC == HIGH ? "HIGH" : "LOW");
  Serial.print(", ");
  Serial.print(digitalRead(pin4) == HIGH ? "ON" : "OFF");
  Serial.print(", ");
  Serial.println(message);
}
